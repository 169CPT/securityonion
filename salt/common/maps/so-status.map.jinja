{% set role = grains.id.split('_') | last %}
{% from 'common/map/'~ role ~'.map.jinja' import docker with context %}

# Check if the service is enabled and append it's required containers
# to the list predefined by the role / minion id affix
{% macro append_containers(pillar_name, k, compare )%}
  {% if salt['pillar.get'](pillar_name~':'~k, {}) !=  %}
    {% from 'common/maps/'~k~'.map.jinja' import docker as d with context %}
    {% for li in d['containers'] %}
      {{ docker['containers'].append(li) }}
    {% endfor %}
  {% endif %}
{% endmacro %}

{% set docker = salt['grains.filter_by']({
  '*_'~role: {
    'containers': docker['containers']
  } 
},grain='id', merge=salt['pillar.get']('docker')) %}

{% if role == 'eval' %}
  {{ append_containers('master', 'grafana', '0') }}
  {{ append_containers('static', 'fleet_master', '0') }}
  {{ append_containers('master', 'wazuh', '0') }}
  {{ append_containers('master', 'thehive', '0') }}
  {{ append_containers('master', 'playbook', '0') }}
  {{ append_containers('master', 'freq', '0') }}
  {{ append_containers('master', 'domainstats', '0') }}
{% endif %}

{% if role == 'heavynode' %}
  {{ append_containers('static', 'broversion', 'SURICATA') }}
{% endif %}

{% if role == 'mastersearch' %}
  {{ append_containers('master', 'grafana', '0') }}
  {{ append_containers('static', 'fleet_master, '0'') }}
  {{ append_containers('master', 'wazuh', '0') }}
  {{ append_containers('master', 'thehive', '0') }}
  {{ append_containers('master', 'playbook', '0') }}
  {{ append_containers('master', 'freq', '0') }}
  {{ append_containers('master', 'domainstats', '0') }}
{% endif %}

{% if role == 'master' %}
  {{ append_containers('master', 'grafana', '0') }}
  {{ append_containers('static', 'fleet_master', '0') }}
  {{ append_containers('master', 'wazuh', '0') }}
  {{ append_containers('master', 'thehive', '0') }}
  {{ append_containers('master', 'playbook', '0') }}
  {{ append_containers('master', 'freq', '0') }}
  {{ append_containers('master', 'domainstats', '0') }}
{% endif %}

{% if role == 'searchnode' %}
  {{ append_containers('master', 'wazuh', '0') }}
{% endif %}

{% if role == 'sensor' %}
  {{ append_containers('static', 'broversion', 'SURICATA') }}
{% endif %}