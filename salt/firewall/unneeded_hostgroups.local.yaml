{% import_yaml 'firewall/port_groups.yaml' as default_port_groups %}
{% set default_port_groups = default_port_groups.firewall.aliases.ports %}

{% import_yaml 'firewall/port_groups.local.yaml' as local_port_groups %}
{% set local_port_groups = local_port_groups.firewall.aliases.ports %}

{% set port_groups = local_port_groups, default=default_port_groups, merge=True %}

firewall:
  aliases:
    analyst:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.nginx }}
    beats_endpoint:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.beats_5044 }}
    dockernet:
      ips:
        delete:
        allow:
          - 172.17.0.0/24
    fleet:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.mysql }}
        - {{ port_groups.redis }}
        - {{ port_groups.osquery_8080 }}
    heavy_node:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.redis }}
        - {{ port_groups.beats_5044 }}
        - {{ port_groups.beats_5644 }}
    localhost:
      ips:
        delete:
        allow:
          - 127.0.0.1
    master:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.wazuh_endpoint }}
        - {{ port_groups.playbook }}
        - {{ port_groups.mysql }}
        - {{ port_groups.navigator }}
        - {{ port_groups.kibana }}
        - {{ port_groups.redis }}
        - {{ port_groups.influxdb }}
        - {{ port_groups.osquery_8090 }}
        - {{ port_groups.cortex }}
        - {{ port_groups.elasticsearch_rest }}
        - {{ port_groups.elasticsearch_node }}
        - {{ port_groups.cortex_es_rest }}
        - {{ port_groups.cortex_es_node }}
    minion:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.acng }}
        - {{ port_groups.salt_master }}
        - {{ port_groups.docker_registry }}
        - {{ port_groups.osquery_8080 }}
        - {{ port_groups.influxdb }}
        - {{ port_groups.wazuh_minion }}
    node:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.elasticsearch_node }}
    osquery_endpoint:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.osquery_8090 }}
    search_node:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.redis }}
        - {{ port_groups.elasticsearch_node }}
    self:
      ips:
        delete:
        allow:
          - {{ salt['grains.get']('ip_interfaces').get(salt['pillar.get']('sensor:mainint', salt['pillar.get']('master:mainint', salt['pillar.get']('node:mainint'))))[0] }}
    sensor:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.sensoroni }}
        - {{ port_groups.beats_5044 }}
        - {{ port_groups.beats_5644 }}
    wazuh_endpoint:
      ips:
        delete:
        allow:
      port_groups:
        - {{ port_groups.wazuh_endpoint }}